name: Build Recipe JSON

on:
  # æ¯å¤©è‡ªåŠ¨è¿è¡Œä¸€æ¬¡ï¼ˆUTC æ—¶é—´ 00:00ï¼ŒåŒ—äº¬æ—¶é—´ 08:00ï¼‰
  schedule:
    - cron: '0 0 * * *'
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  
  # å½“ convert_recipes.py è¢«ä¿®æ”¹æ—¶è§¦å‘
  push:
    paths:
      - 'convert_recipes.py'
      - '.github/workflows/build-recipes.yml'

jobs:
  build:
    runs-on: ubuntu-latest
    
    # æ·»åŠ å†™å…¥æƒé™
    permissions:
      contents: write
    
    steps:
      - name: Checkout å½“å‰ä»“åº“
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 2 # éœ€è¦çˆ¶æäº¤ç”¨äºŽæ£€æµ‹ convert_recipes.py æ˜¯å¦å˜æ›´
      
      - name: è®¾ç½® Python çŽ¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: å…‹éš† HowToCook ä»“åº“
        run: |
          git clone https://github.com/Anduin2017/HowToCook.git
          echo "HowToCook ä»“åº“å…‹éš†å®Œæˆ"
      
      - name: æ£€æŸ¥è½¬æ¢è„šæœ¬æ˜¯å¦æœ‰æ”¹åŠ¨
        id: check_script
        run: |
          # æ£€æŸ¥æœ€è¿‘ä¸€æ¬¡æäº¤æ˜¯å¦ä¿®æ”¹äº† convert_recipes.py
          CHANGED_FILES=$(git diff-tree --no-commit-id --name-only -r HEAD)
          if echo "$CHANGED_FILES" | grep -q "convert_recipes.py"; then
            echo "script_changed=true" >> $GITHUB_OUTPUT
            echo "ðŸ”§ æ£€æµ‹åˆ° convert_recipes.py æœ‰æ”¹åŠ¨ï¼Œå°†å¼ºåˆ¶é‡æ–°ç”Ÿæˆ"
          else
            echo "script_changed=false" >> $GITHUB_OUTPUT
            echo "ðŸ“ convert_recipes.py æ²¡æœ‰æ”¹åŠ¨"
          fi
      
      - name: èŽ·å– HowToCook commit hash å¹¶åˆ¤æ–­æ˜¯å¦éœ€è¦æž„å»º
        id: check_hash
        run: |
          # èŽ·å–æœ€æ–°çš„ commit hash
          cd HowToCook
          UPSTREAM_HASH=$(git rev-parse HEAD)
          cd ..
          echo "upstream_hash=$UPSTREAM_HASH" >> $GITHUB_OUTPUT
          echo "HowToCook æœ€æ–° commit: $UPSTREAM_HASH"
          
          # å¦‚æžœè½¬æ¢è„šæœ¬æœ‰æ”¹åŠ¨ï¼Œç›´æŽ¥æž„å»º
          if [ "${{ steps.check_script.outputs.script_changed }}" = "true" ]; then
            echo "should_build=true" >> $GITHUB_OUTPUT
            echo "last_hash=" >> $GITHUB_OUTPUT
            echo "ðŸ”§ è½¬æ¢è„šæœ¬æœ‰æ”¹åŠ¨ï¼Œå¼ºåˆ¶é‡æ–°ç”Ÿæˆ JSON"
            exit 0
          fi
          
          # æ£€æŸ¥ä¸Šæ¬¡æž„å»ºçš„ hash
          if [ -f .last_build_hash ]; then
            LAST_HASH=$(cat .last_build_hash)
            echo "last_hash=$LAST_HASH" >> $GITHUB_OUTPUT
            echo "ä¸Šæ¬¡æž„å»ºçš„ commit: $LAST_HASH"
            
            # åˆ¤æ–­æ˜¯å¦éœ€è¦æž„å»º
            if [ "$LAST_HASH" = "$UPSTREAM_HASH" ]; then
              echo "should_build=false" >> $GITHUB_OUTPUT
              echo "â­ï¸ HowToCook ä»“åº“æ²¡æœ‰æ›´æ–°ï¼Œè·³è¿‡æž„å»º"
            else
              echo "should_build=true" >> $GITHUB_OUTPUT
              echo "ðŸ”„ æ£€æµ‹åˆ° HowToCook ä»“åº“æœ‰æ›´æ–°ï¼Œå¼€å§‹æž„å»º"
            fi
          else
            echo "last_hash=" >> $GITHUB_OUTPUT
            echo "should_build=true" >> $GITHUB_OUTPUT
            echo "ðŸ†• é¦–æ¬¡æž„å»ºï¼Œæ²¡æœ‰åŽ†å²è®°å½•"
          fi
      
      - name: è¿è¡Œè½¬æ¢è„šæœ¬
        if: steps.check_hash.outputs.should_build == 'true'
        run: |
          python convert_recipes.py
          echo "è½¬æ¢å®Œæˆï¼Œç”Ÿæˆçš„æ–‡ä»¶ï¼š"
          ls -lh target/all_recipes.json
      
      - name: ä¿å­˜ commit hash
        if: steps.check_hash.outputs.should_build == 'true'
        run: |
          echo "${{ steps.check_hash.outputs.upstream_hash }}" > .last_build_hash
          echo "å·²ä¿å­˜ commit hash åˆ° .last_build_hash"
      
      - name: æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
        if: steps.check_hash.outputs.should_build == 'true'
        id: check_changes
        run: |
          git add target/all_recipes.json .last_build_hash
          if git diff --staged --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "æ²¡æœ‰æ£€æµ‹åˆ°å˜åŒ–"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "æ£€æµ‹åˆ°å˜åŒ–"
          fi
      
      - name: æäº¤å¹¶æŽ¨é€æ›´æ”¹
        if: steps.check_hash.outputs.should_build == 'true' && steps.check_changes.outputs.has_changes == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git commit -m "ðŸ¤– è‡ªåŠ¨æ›´æ–°èœè°±æ•°æ® - $(date +'%Y-%m-%d %H:%M:%S')" -m "HowToCook commit: ${{ steps.check_hash.outputs.upstream_hash }}"
          git push
      
      - name: ç”Ÿæˆæž„å»ºæŠ¥å‘Š
        if: always()
        run: |
          echo "## æž„å»ºæŠ¥å‘Š ðŸ“Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # æ˜¾ç¤º commit hash ä¿¡æ¯
          echo "### Commit ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "- HowToCook æœ€æ–°: \`${{ steps.check_hash.outputs.upstream_hash }}\`" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ steps.check_hash.outputs.last_hash }}" ]; then
            echo "- ä¸Šæ¬¡æž„å»º: \`${{ steps.check_hash.outputs.last_hash }}\`" >> $GITHUB_STEP_SUMMARY
          fi
          
          # æ˜¾ç¤ºè½¬æ¢è„šæœ¬çŠ¶æ€
          if [ "${{ steps.check_script.outputs.script_changed }}" = "true" ]; then
            echo "- ðŸ”§ è½¬æ¢è„šæœ¬: **æœ‰æ”¹åŠ¨ï¼ˆå¼ºåˆ¶é‡æ–°ç”Ÿæˆï¼‰**" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # æ˜¾ç¤ºæ˜¯å¦è·³è¿‡æž„å»º
          if [ "${{ steps.check_hash.outputs.should_build }}" = "false" ]; then
            echo "â­ï¸ **è·³è¿‡æž„å»º** - HowToCook ä»“åº“æ²¡æœ‰æ›´æ–°" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi
          
          if [ -f target/all_recipes.json ]; then
            RECIPE_COUNT=$(python -c "import json; print(len(json.load(open('target/all_recipes.json', 'r', encoding='utf-8'))))")
            FILE_SIZE=$(du -h target/all_recipes.json | cut -f1)
            
            echo "âœ… **æž„å»ºæˆåŠŸ**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ“ èœè°±æ•°é‡: **${RECIPE_COUNT}** ä¸ª" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ“¦ æ–‡ä»¶å¤§å°: **${FILE_SIZE}**" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ• æž„å»ºæ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
            
            # åˆ†ç±»ç»Ÿè®¡
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### åˆ†ç±»ç»Ÿè®¡" >> $GITHUB_STEP_SUMMARY
            python3 << 'PYTHON_SCRIPT' >> $GITHUB_STEP_SUMMARY
          import json
          from collections import Counter
          
          with open('target/all_recipes.json', 'r', encoding='utf-8') as f:
              data = json.load(f)
              
          categories = Counter(r['category'] for r in data)
          for cat, count in sorted(categories.items(), key=lambda x: -x[1]):
              print(f'- {cat}: {count} ä¸ª')
          PYTHON_SCRIPT
          else
            echo "âŒ **æž„å»ºå¤±è´¥**" >> $GITHUB_STEP_SUMMARY
          fi
