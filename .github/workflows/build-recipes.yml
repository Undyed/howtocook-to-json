name: Build Recipe JSON

on:
  # æ¯å¤©è‡ªåŠ¨è¿è¡Œä¸€æ¬¡ï¼ˆUTC æ—¶é—´ 00:00ï¼ŒåŒ—äº¬æ—¶é—´ 08:00ï¼‰
  schedule:
    - cron: '0 0 * * *'
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  
  # å½“ convert_recipes.py è¢«ä¿®æ”¹æ—¶è§¦å‘
  push:
    paths:
      - 'convert_recipes.py'
      - '.github/workflows/build-recipes.yml'

jobs:
  build:
    runs-on: ubuntu-latest
    
    # æ·»åŠ å†™å…¥æƒé™
    permissions:
      contents: write
    
    steps:
      - name: Checkout å½“å‰ä»“åº“
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: è®¾ç½® Python çŽ¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: å…‹éš† HowToCook ä»“åº“
        run: |
          git clone https://github.com/Anduin2017/HowToCook.git
          echo "HowToCook ä»“åº“å…‹éš†å®Œæˆ"
          ls -la HowToCook/dishes | head -20
      
      - name: è¿è¡Œè½¬æ¢è„šæœ¬
        run: |
          python convert_recipes.py
          echo "è½¬æ¢å®Œæˆï¼Œç”Ÿæˆçš„æ–‡ä»¶ï¼š"
          ls -lh target/all_recipes.json
      
      - name: æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
        id: check_changes
        run: |
          git add target/all_recipes.json
          if git diff --staged --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "æ²¡æœ‰æ£€æµ‹åˆ°å˜åŒ–"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "æ£€æµ‹åˆ°å˜åŒ–"
          fi
      
      - name: æäº¤å¹¶æŽ¨é€æ›´æ”¹
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git commit -m "ðŸ¤– è‡ªåŠ¨æ›´æ–°èœè°±æ•°æ® - $(date +'%Y-%m-%d %H:%M:%S')"
          git push
      
      - name: ç”Ÿæˆæž„å»ºæŠ¥å‘Š
        if: always()
        run: |
          echo "## æž„å»ºæŠ¥å‘Š ðŸ“Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f target/all_recipes.json ]; then
            RECIPE_COUNT=$(python -c "import json; print(len(json.load(open('target/all_recipes.json', 'r', encoding='utf-8'))))")
            FILE_SIZE=$(du -h target/all_recipes.json | cut -f1)
            
            echo "âœ… **æž„å»ºæˆåŠŸ**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ“ èœè°±æ•°é‡: **${RECIPE_COUNT}** ä¸ª" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ“¦ æ–‡ä»¶å¤§å°: **${FILE_SIZE}**" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ• æž„å»ºæ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
            
            # åˆ†ç±»ç»Ÿè®¡
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### åˆ†ç±»ç»Ÿè®¡" >> $GITHUB_STEP_SUMMARY
            python3 << 'PYTHON_SCRIPT' >> $GITHUB_STEP_SUMMARY
          import json
          from collections import Counter
          
          with open('target/all_recipes.json', 'r', encoding='utf-8') as f:
              data = json.load(f)
              
          categories = Counter(r['category'] for r in data)
          for cat, count in sorted(categories.items(), key=lambda x: -x[1]):
              print(f'- {cat}: {count} ä¸ª')
          PYTHON_SCRIPT
          else
            echo "âŒ **æž„å»ºå¤±è´¥**" >> $GITHUB_STEP_SUMMARY
          fi
